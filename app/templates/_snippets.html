{% macro dataset_summary(dataset) -%}
  <div class="dataset summary">
    <img src="https://assets.okfn.org/p/data/img/icon-128.png"
      alt="{{dataset.title}}" class="logo" />
    <h3><a href="/{{dataset.owner}}/{{dataset.id}}">{{dataset.title}}</a></h3>
    <div class="description">{{dataset.description}}</div>
    <div class="actions">
      <a href="/{{dataset.owner}}/{{dataset.id}}" class="btn btn-primary btn-small">View &raquo;</a>
      {% if dataset.download_url %}
      <a href="{{dataset.download_url}}" class="btn btn-success btn-small">Download CSV &raquo;</a>
      {% endif %}
    </div>
    <div class="source">Source: {{listify(dataset.sources)}}</div>
    <ul class="keywords">
      {% for kw in dataset.keywords or [] %}
      <li>{{kw}}</li>
      {% endfor %}
    </ul>
  </div>
{%- endmacro %}

{% macro listify(list_) -%}
  {% for item in list_ or [] %}
  <a href="{{item.web}}" title="Uses data from {{item.name}}" target="_blank">
    <i class="fa fa-external-link-square"></i>
    {{item.name}}
  </a>
  {% endfor %}
{%- endmacro %}

{% macro dataset_show(dataset, jsonDataPackage, dataViews, showDataApi, datapackageUrl, readmeShort) -%}
<div class="dataset row row-eq-height">
  <div class="col-sm-3 side-bar">
    <div class="side-section">
      <h3>KEY INFO</h3>
      <p>Format(s):</p>
      <ol>
      {% for resource in dataset.resources %}
        <li>
        {% if resource.format %}
          {{ resource.format }}
        {% else %}
          not provided
        {% endif %}
        </li>
      {% endfor %}
      </ol>

      <p>More datasets from <a href="/{{ dataset.owner }}" class="explore">{{ dataset.owner }}</a></p>
      <div class="btn-group">
        <a href="{{ datapackageUrl }}" class="btn btn-xs btn-default" target="_blank"><small>Data Package Descriptor (JSON)</small></a>
        {% if dataset.bugs and dataset.bugs.url %}
        <a href="{{dataset.bugs.url}}" class="btn btn-xs btn-default" target="_blank">Report an Issue</a>
        {% endif %}
      </div>
      <div class="homepage truncate">
        <!-- <p class="small">
          <i class="fa fa-home"></i> <a href="{{dataset.homepage}}" title="Home Page">Home page</a>
        </p> -->
        <p class="small">
          Sources:<br>
          {{listify(dataset.sources)}}
        </p>
      </div>
      {% if dataset.licenses %}
      <div class="license">
        <i class="fa fa-gavel"></i> <a href="{{dataset.licenses[0].url}}" title="Available under the following License">{{dataset.licenses[0].name or dataset.licenses[0].id}}</a>
        <br />
        <a href="https://opendefinition.org" title="This data is open data as per the Open Definition"><img src="https://assets.okfn.org/images/buttons/od_80x15_blue.png" /></a>
      </div>
      {% elif dataset.license %}
      <div class="license">
        <i class="fa fa-gavel"></i> {{ dataset.license }}
        <br />
        <a href="https://opendefinition.org" title="This data is open data as per the Open Definition"><img src="https://assets.okfn.org/images/buttons/od_80x15_blue.png" /></a>
      </div>
      {% endif %}
    </div>

    <div class="side-section">
      <a href="#data" class="btn btn-sm btn-primary" onclick="scrollDown(this)">Download</a>
    </div>
    <div class="side-section">
      <h3>ABOUT</h3>
      <div class="description">{{readmeShort|truncate}} <a href="#readme" class="explore" onclick="scrollDown(this)">read more</a></div>
    </div>
  </div>

  <div class="col-sm-9 main-section">
    <div class="react-me part" data-type="data-views" id="next-section"></div>
    <div class="resources part" id="data">
      <ul class="nav nav-pills">
        <li class="active"><a data-toggle="pill" href="#download">Get data</a></li>
        <li><a data-toggle="pill" href="#r">R</a></li>
        <li><a data-toggle="pill" href="#pandas">Pandas</a></li>
      </ul>

      <div class="tab-content">
        <div id="download" class="tab-pane fade in active">
          <h2>DATA FILES</h2>
          <div class="resource-listing part">
            <table class="table table-bordered table-striped resource-listing">
              <thead>
                <th>Name</th>
                <th>Format</th>
                <th>Link</th>
              </thead>
              <tbody>
              {% for resource in dataset.resources %}
                <tr>
                  <td><i class="fa fa-file-text-o"></i> <a href="#resource-{{resource.name}}" class="explore" onclick="scrollDown(this)">{{resource.name}}</a></td>
                  <td>{{ resource.format }}</td>
                  <td class="download truncate">
                      <a href="{{ datapackageUrl | replace("/datapackage.json","")}}/{{ resource.path }}" class="btn btn-xs btn-primary">
                          <i class="fa fa-arrow-circle-down" aria-hidden="true"></i> Download
                      </a>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div id="r" class="tab-pane fade">
          <h2>Using in R</h2>
          <div class="part">
            <p>In order to use Data Package in R follow instructions below:</p>
            <pre>
              <code>
install.packages("devtools")

library(devtools)
install_github("hadley/readr")
install_github("ropenscilabs/jsonvalidate")
install_github("ropenscilabs/datapkg")

#Load client
library(datapkg)

#Get Data Package
datapackage &lt;- datapkg_read("https://bits.datapackaged.com/metadata/{{ dataset.owner }}/{{ dataset.name }}/_v/latest")

#Package info
print(datapackage)

#Open actual data in RStudio Viewer
{% for resource in dataset.resources %}
View(datapackage$data$"{{ resource.name }}")
{% endfor %}
              </code>
            </pre>
          </div>
        </div>

        <div id="pandas" class="tab-pane fade">
          <h2>Using in Pandas</h2>
          <div class="part">
            <p>Tested with Python 3.5.2</p>
            <p>In order to work with Data Packages in Pandas you need to install our packages:</p>
            <pre>
              <code>
$ pip install datapackage
$ pip install jsontableschema-pandas
              </code>
            </pre>
            <p>To get Data Package run following code:</p>
            <pre>
              <code>
import datapackage

data_url = "https://bits.datapackaged.com/metadata/{{ dataset.owner }}/{{ dataset.name }}/_v/latest/datapackage.json"

# to load Data Package into storage
storage = datapackage.push_datapackage(data_url, 'pandas')
# to see datasets in this package
storage.buckets
# you can access datasets inside storage, e.g. the first one:
storage[storage.buckets[0]]
              </code>
            </pre>
          </div>
        </div>
      </div>
      <script>
        // this is for tabs to work as anchors
        jQuery("ul.nav-pills > li > a").on("shown.bs.tab", function (e) {
           scrollposition = jQuery(document).scrollTop();
           var id = jQuery(e.target).attr("href").substr(1);
           window.location.hash = id;
           jQuery(document).scrollTop(scrollposition);
        });
        var hash = window.location.hash;
        jQuery('.nav.nav-pills a[href="' + hash + '"]').tab('show', function() {
            jQuery(document).scrollTop();
        });
      </script>
      {% for resource in dataset.resources %}
      <div class="resource-info part">
        <h2 id="resource-{{resource.name}}">PREVIEW ({{resource.name}})</h2>
        <div id="resource-{{loop.index - 1}}" class="react-me tables"
             data-type="resource-preview" data-resource="{{ loop.index - 1 }}"></div>
        <div class="row download">
          <a href="{{ datapackageUrl | replace("/datapackage.json","")}}/{{ resource.path }}" class="btn btn-sm btn-primary pull-right">
            Download
          </a>
        </div>
        {% if resource.format == "csv" %}
         <h2>FIELD INFORMATION</h2>
         <table class="table table-bordered table-striped resource-summary">
           <thead>
             <tr>
               <th>Field Name</th>
               <th>Order</th>
               <th>Type (Format)</th>
               <th>Description</th>
             </tr>
           </thead>
           <tbody>
             {% for field in resource.schema.fields %}
             <tr>
               <th>{{field.name}}</th>
               <td>{{loop.index}}</td>
               <td class="type type-{{field.type}}">{{field.type}} {% if field.format %}({{field.format}}) {% endif %}</td>
               <td>{{field.description}}</td>
             </tr>
             {% endfor %}
           </tbody>
         </table>
       {% endif %}
      </div>
      {% endfor %}
    </div> <!-- / resoures -->

    <div class="row moreinfo">
      <div class="col-md-8">
        <h2 id="readme">README</h2>
        <div class="readme">{{dataset.readme|safe}}</div>
      </div>
      <div class="col-md-4"></div>
    </div>

    <script type="text/javascript">
      var DATA_PACKAGE_URL = "{{ datapackageUrl }}";
    </script>
  </div>
</div><!-- / dataset show -->
{%- endmacro %}

{% macro package_list_show(publisher, packages) -%}
  {%- for package in packages  %}
  <div class="row package-summary">
    <div class="col-xs-3">
      <img src="{{ s3_cdn }}/static/img/cube16.svg" class="img-responsive cube" />
    </div>
    <div class="col-xs-9">
      <a href="/{{ package.publisher_name }}/{{ package.name }}">
        <h3>{{ package.descriptor.title }}</h3>
      </a>
      <div class="row show-grid clearfix">
        <div class="col-sm-1 col-xs-2 icon">
          <img src="https://avatars3.githubusercontent.com/u/22451011?v=3&s=200" class="img-responsive img-circle" />
        </div>
        <div class="col-sm-5 col-xs-4 publisher">
            <small><a href="/{{ package.publisher_name }} " class="explore">by {{ package.publisher_name }}</a></small>
        </div>
      </div>
      <h6 class="text-left">
        <b>{{ package.name }}</b> | files {{ package.descriptor.resources|length }}
      </h6>
      {% if package.readme %}
      <p>
        {{ package.readme|truncate }}
        <a href="/{{ package.publisher_name }}/{{ package.name }}" class="explore">
          explore more <span>&rsaquo;</span>
        </a>
      </p>
      {% endif %}
    </div>
  </div>
  {%- endfor %}
{%- endmacro %}

{% macro search_package_list(packages) -%}
  {%- for package in packages %}
    <div class="row package-summary">
      <div class="col-xs-3">
        <img src="{{ s3_cdn }}/static/img/cube16.svg" class="img-responsive cube" />
      </div>
      <div class="col-xs-9">
        <a href="/{{ package.publisher_name }}/{{ package.name }}">
          <h3>{{ package.descriptor.title }}</h3>
        </a>
        <div class="row show-grid clearfix">
          <div class="col-sm-1 col-xs-2 icon">
            <img src="https://avatars3.githubusercontent.com/u/22451011?v=3&s=200" class="img-responsive img-circle" />
          </div>
          <div class="col-sm-5 col-xs-4 publisher">
              <small><a href="/{{ package.publisher_name }} " class="explore">by {{ package.publisher_name }}</a></small>
          </div>
        </div>
        <h6 class="text-left">
          <b>{{ package.name }}</b> | files {{ package.descriptor.resources|length }}
        </h6>
        {% if package.readme %}
        <p>
          {{ package.readme|truncate }}
          <a href="/{{ package.publisher_name }}/{{ package.name }}" class="explore">
            explore more <span>&rsaquo;</span>
          </a>
        </p>
        {% endif %}
      </div>
    </div>
  {%- endfor %}
{%- endmacro %}
